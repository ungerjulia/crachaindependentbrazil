<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crachá IB</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@300;400;500;700&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  :root {
    --black: #1a1a1a; --white: #ffffff;
    --border: #e0e0e0; --mid-gray: #888;
    --clt: #111111; --pj: #5a5a5a;
  }
  body { font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; background:#f5f5f5; color:var(--black); min-height:100vh; }

  /* HEADER */
  header { background:var(--black); padding:20px 40px; display:flex; align-items:center; gap:16px; }
  .logo-box { width:40px; height:40px; background:#fff; display:flex; align-items:center; justify-content:center; position:relative; }
  .logo-box::before { content:''; position:absolute; inset:4px; border:2px solid var(--black); }
  .logo-box span { font-size:14px; font-weight:700; color:var(--black); position:relative; z-index:1; }
  header h1 { color:#fff; font-size:16px; font-weight:300; letter-spacing:3px; text-transform:uppercase; }

  /* LAYOUT */
  .container { max-width:1100px; margin:0 auto; padding:48px 32px; display:grid; grid-template-columns:360px 1fr; gap:48px; align-items:start; }

  /* FORM */
  .form-panel { background:white; padding:36px; border:1px solid var(--border); }
  .form-panel h2 { font-size:11px; font-weight:500; letter-spacing:2px; text-transform:uppercase; color:var(--mid-gray); margin-bottom:32px; padding-bottom:16px; border-bottom:1px solid var(--border); }
  .field { margin-bottom:24px; }
  .field > label { display:block; font-size:10px; font-weight:500; letter-spacing:1.5px; text-transform:uppercase; color:var(--mid-gray); margin-bottom:8px; }
  input[type="text"], input[type="date"] { width:100%; padding:12px 0; border:none; border-bottom:1.5px solid var(--border); background:transparent; font-family:inherit; font-size:15px; color:var(--black); outline:none; transition:border-color 0.2s; }
  input[type="text"]:focus, input[type="date"]:focus { border-color:var(--black); }

  /* TYPE SELECTOR */
  .type-selector { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px; }
  .type-option { cursor:pointer; position:relative; }
  .type-option input { position:absolute; opacity:0; pointer-events:none; }
  .type-swatch { padding:12px; border:1.5px solid var(--border); text-align:center; font-size:11px; letter-spacing:1.5px; text-transform:uppercase; font-weight:500; transition:all 0.2s; color:var(--mid-gray); }
  .type-option input:checked + .type-swatch { border-color:var(--black); color:var(--black); background:#fafafa; }

  /* PHOTO UPLOAD */
  .photo-upload { border:1.5px dashed var(--border); padding:24px; text-align:center; cursor:pointer; transition:border-color 0.2s; position:relative; overflow:hidden; margin-bottom:8px; }
  .photo-upload:hover { border-color:var(--black); }
  .photo-upload input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .photo-preview { width:80px; height:80px; border-radius:50%; object-fit:cover; margin:0 auto 8px; display:none; }
  .upload-icon { font-size:24px; margin-bottom:8px; display:block; color:var(--mid-gray); }
  .upload-text { font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--mid-gray); }

  /* PHOTO QUALITY */
  .photo-quality { margin-bottom:20px; padding:10px 14px; font-size:11px; display:none; border-left:3px solid; }
  .photo-quality.ok   { border-color:#2e7d32; background:#f1f8e9; color:#2e7d32; }
  .photo-quality.warn { border-color:#e65100; background:#fff3e0; color:#e65100; }
  .photo-quality.bad  { border-color:#c62828; background:#ffebee; color:#c62828; }

  /* NAME/ROLE WITH CASE TOGGLE */
  .input-with-toggle { display:flex; align-items:flex-end; gap:8px; border-bottom:1.5px solid var(--border); transition:border-color 0.2s; }
  .input-with-toggle:focus-within { border-color:var(--black); }
  .input-with-toggle input { border-bottom:none !important; flex:1; padding-bottom:10px; text-transform:none; }
  .case-toggle { flex-shrink:0; padding:0 0 10px; background:none; border:none; font-family:inherit; font-size:10px; font-weight:700; color:var(--mid-gray); cursor:pointer; transition:color 0.2s; text-transform:none; }
  .case-toggle.active { color:var(--black); }
  .case-toggle:hover { color:var(--black); }

  /* BUTTONS */
  .btn-generate { width:100%; padding:16px; background:var(--black); color:white; border:none; font-family:inherit; font-size:11px; font-weight:500; letter-spacing:2.5px; text-transform:uppercase; cursor:pointer; transition:opacity 0.2s; margin-bottom:12px; }
  .btn-generate:hover { opacity:0.8; }
  .export-btns { display:none; gap:10px; margin-bottom:0; }
  .export-btns.visible { display:grid; grid-template-columns:1fr 1fr; }
  .btn-export { padding:13px 8px; font-family:inherit; font-size:10px; font-weight:500; letter-spacing:1.5px; text-transform:uppercase; cursor:pointer; transition:all 0.2s; border:1.5px solid var(--black); background:transparent; color:var(--black); }
  .btn-export:hover { background:var(--black); color:white; }
  .btn-export.primary { background:var(--black); color:white; }
  .btn-export.primary:hover { opacity:0.8; }

  /* PREVIEW PANEL */
  .preview-panel { display:flex; flex-direction:column; gap:32px; }
  .preview-panel h2 { font-size:11px; font-weight:500; letter-spacing:2px; text-transform:uppercase; color:var(--mid-gray); padding-bottom:16px; border-bottom:1px solid var(--border); }
  .cards-row { display:flex; gap:28px; flex-wrap:wrap; align-items:flex-start; }
  .card-group { display:flex; flex-direction:column; align-items:center; gap:10px; }
  .card-label-small { font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--mid-gray); text-align:center; }

  /* SPECS BAR */
  .specs-info { background:white; border:1px solid var(--border); padding:18px 24px; display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
  .spec { text-align:center; }
  .spec-value { font-size:14px; font-weight:400; letter-spacing:0.5px; }
  .spec-key { font-size:9px; letter-spacing:1.5px; text-transform:uppercase; color:var(--mid-gray); margin-top:3px; }

  /* PRINT NOTE */
  .print-note { background:#f9f9f9; border:1px solid var(--border); padding:16px 20px; font-size:11px; color:var(--mid-gray); line-height:1.7; }
  .print-note strong { color:var(--black); }

  /* BADGE PREVIEW — 54x86mm ratio */
  .badge { width:190px; height:303px; border-radius:10px; overflow:hidden; position:relative; box-shadow:0 8px 32px rgba(0,0,0,0.25); flex-shrink:0; }
  .badge-slot { position:absolute; top:11px; left:50%; transform:translateX(-50%); width:44px; height:12px; background:rgba(0,0,0,0.5); border-radius:6px; z-index:10; }

  /* FRONT */
  .badge-front { display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:30px 12px 18px; height:100%; background:var(--clt); }
  .badge-front.pj { background:var(--pj); }
  .badge-brand { font-size:10.5px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:white; text-align:center; line-height:1.35; flex-shrink:0; }
  .badge-photo-ring { width:120px; height:120px; border-radius:50%; border:2.5px solid rgba(255,255,255,0.25); display:flex; align-items:center; justify-content:center; overflow:hidden; background:rgba(255,255,255,0.12); flex-shrink:0; }
  .badge-photo-ring img { width:100%; height:100%; object-fit:cover; display:none; }
  .badge-photo-placeholder { display:flex; flex-direction:column; align-items:center; gap:3px; }
  .badge-photo-placeholder svg { width:60px; height:60px; fill:rgba(255,255,255,0.45); }
  .badge-photo-size { font-size:7px; color:rgba(255,255,255,0.3); letter-spacing:1px; }
  .badge-info { text-align:center; flex-shrink:0; }
  .badge-name { font-size:9.5px; font-weight:700; color:white; letter-spacing:0.5px; margin-bottom:3px; word-break:break-word; text-align:center; line-height:1.4; max-width:160px; }
  .badge-role { font-size:8px; color:rgba(255,255,255,0.55); letter-spacing:0.5px; word-break:break-word; text-align:center; line-height:1.4; max-width:160px; }

  /* BACK */
  .badge-back { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; padding:16px 14px; height:100%; background:var(--clt); }
  .badge-back.pj { background:var(--pj); }
  .badge-logo-box { width:90px; height:90px; border:6px solid white; display:flex; align-items:center; justify-content:center; }
  .badge-logo-text { font-size:50px; font-weight:700; color:white; letter-spacing:-2px; line-height:1; }
  .badge-back-bottom { text-align:center; }
  .badge-admission-label { font-size:7px; color:rgba(255,255,255,0.45); margin-bottom:2px; }
  .badge-admission-date { font-size:9px; font-weight:700; color:white; margin-bottom:5px; }
  .badge-website { font-size:7px; font-weight:700; color:white; }

  canvas { display:none; }
</style>
</head>
<body>

<header>
  <div class="logo-box"><span>IB</span></div>
  <h1>Crachá IB</h1>
</header>

<div class="container">

  <!-- FORM -->
  <div class="form-panel">
    <h2>Configurar Crachá</h2>

    <div class="field">
      <label>Tipo de Vínculo</label>
      <div class="type-selector">
        <label class="type-option">
          <input type="radio" name="type" value="CLT" checked onchange="updatePreview()">
          <div class="type-swatch">CLT — Preto</div>
        </label>
        <label class="type-option">
          <input type="radio" name="type" value="PJ" onchange="updatePreview()">
          <div class="type-swatch">PJ — Cinza</div>
        </label>
      </div>
    </div>

    <div class="field">
      <label>Foto do Colaborador (35×35mm)</label>
      <div class="photo-upload">
        <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event)">
        <img class="photo-preview" id="photoPreview" alt="">
        <span class="upload-icon" id="uploadIcon">↑</span>
        <div class="upload-text" id="uploadText">Clique para enviar a foto</div>
      </div>
      <div class="photo-quality" id="photoQuality"></div>
    </div>

    <div class="field">
      <label>Nome Completo</label>
      <div class="input-with-toggle">
        <input type="text" id="nameInput" placeholder="Ex: João da Silva" oninput="updatePreview()">
        <button class="case-toggle" id="nameCase" onclick="toggleCase('name')">Aa</button>
      </div>
    </div>

    <div class="field">
      <label>Função</label>
      <div class="input-with-toggle">
        <input type="text" id="roleInput" placeholder="Ex: Designer Gráfico" oninput="updatePreview()">
        <button class="case-toggle" id="roleCase" onclick="toggleCase('role')">Aa</button>
      </div>
    </div>

    <div class="field" id="admissionField">
      <label>Data de Admissão</label>
      <input type="date" id="admissionInput" onchange="updatePreview()">
    </div>

    <div class="field" id="cnpjField" style="display:none">
      <label>CNPJ</label>
      <input type="text" id="cnpjInput" placeholder="00.000.000/0000-00" oninput="updatePreview(); formatCNPJ(this)">
    </div>

    <button class="btn-generate" onclick="generateBadge()">Gerar Crachá</button>
    <div class="export-btns" id="exportBtns">
      <button class="btn-export primary" onclick="downloadPDF()">↓ PDF Gráfica</button>
      <button class="btn-export" onclick="downloadPNG()">↓ PNG 300dpi</button>
    </div>
    <canvas id="exportCanvas"></canvas>
  </div>

  <!-- PREVIEW -->
  <div class="preview-panel">
    <h2>Pré-visualização</h2>

    <div class="specs-info">
      <div class="spec"><div class="spec-value">54×86mm</div><div class="spec-key">Dimensões</div></div>
      <div class="spec"><div class="spec-value">300 dpi</div><div class="spec-key">Resolução</div></div>
      <div class="spec"><div class="spec-value">3mm</div><div class="spec-key">Sangria</div></div>
      <div class="spec"><div class="spec-value">PVCL 0.76</div><div class="spec-key">Material</div></div>
    </div>

    <div class="cards-row">
      <!-- FRENTE -->
      <div class="card-group">
        <div class="badge">
          <div class="badge-slot"></div>
          <div class="badge-front" id="badgeFront">
            <div class="badge-brand">INDEPENDENT<br>BRAZIL</div>
            <div class="badge-photo-ring">
              <img id="badgePhoto" src="" alt="">
              <div class="badge-photo-placeholder" id="photoPlaceholder">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
                <span class="badge-photo-size">FOTO 35×35</span>
              </div>
            </div>
            <div class="badge-info">
              <div class="badge-name" id="previewName">&lt;Nome Completo&gt;</div>
              <div class="badge-role" id="previewRole">&lt;Função&gt;</div>
            </div>
          </div>
        </div>
        <div class="card-label-small">Frente · Brilho</div>
      </div>

      <!-- VERSO -->
      <div class="card-group">
        <div class="badge">
          <div class="badge-slot"></div>
          <div class="badge-back" id="badgeBack">
            <div class="badge-logo-box">
              <span class="badge-logo-text">IB</span>
            </div>
            <div class="badge-back-bottom">
              <div class="badge-admission-label" id="backLabel">Admissão:</div>
              <div class="badge-admission-date" id="previewDate">&lt;00/00/00&gt;</div>
              <div class="badge-website">www.independentbrazil.com</div>
            </div>
          </div>
        </div>
        <div class="card-label-small">Verso · Fosco</div>
      </div>
    </div>

    <div class="print-note">
      <strong>Especificações para gráfica:</strong><br>
      Resolução <strong>300dpi</strong> · Dimensões: <strong>638×1016px</strong> (54×86mm) ·
      Com sangria 3mm: <strong>708×1086px</strong> · Frente: PVCL brilho · Verso: PVCL fosco · Espessura: 0,76mm
    </div>
  </div>
</div>

<script>
// ── Estado ────────────────────────────────────────────────────
let photoDataURL = null;
const caseState = { name: false, role: false };

function toggleCase(field) {
  caseState[field] = !caseState[field];
  var btn = document.getElementById(field + 'Case');
  btn.textContent = caseState[field] ? 'AA' : 'Aa';
  if (caseState[field]) { btn.classList.add('active'); } else { btn.classList.remove('active'); }
  updatePreview();
}

function applyCase(text, field) {
  return caseState[field] ? text.toUpperCase() : text;
}

function formatCNPJ(input) {
  var v = input.value.replace(/\D/g,'');
  v = v.replace(/^(\d{2})(\d)/,'$1.$2');
  v = v.replace(/^(\d{2})\.(\d{3})(\d)/,'$1.$2.$3');
  v = v.replace(/\.(\d{3})(\d)/,'.$1/$2');
  v = v.replace(/(\d{4})(\d)/,'$1-$2');
  input.value = v.substring(0,18);
}

// ── Foto ──────────────────────────────────────────────────────
function handlePhoto(e) {
  var file = e.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(ev) {
    photoDataURL = ev.target.result;
    var img = new Image();
    img.onload = function() {
      checkPhotoQuality(img.naturalWidth, img.naturalHeight);
      document.getElementById('photoPreview').src = photoDataURL;
      document.getElementById('photoPreview').style.display = 'block';
      document.getElementById('uploadIcon').style.display = 'none';
      document.getElementById('uploadText').textContent = img.naturalWidth + 'x' + img.naturalHeight + 'px';
      var ph = document.getElementById('badgePhoto');
      ph.src = photoDataURL;
      ph.style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
    };
    img.src = photoDataURL;
  };
  reader.readAsDataURL(file);
}

function checkPhotoQuality(w, h) {
  var el = document.getElementById('photoQuality');
  el.style.display = 'block';
  var small = Math.min(w, h);
  if (small >= 413) {
    el.className = 'photo-quality ok';
    el.textContent = '✓ Boa resolução para impressão (' + w + 'x' + h + 'px)';
  } else if (small >= 200) {
    el.className = 'photo-quality warn';
    el.textContent = '⚠ Qualidade reduzida (' + w + 'x' + h + 'px). Recomendado mínimo 413x413px.';
  } else {
    el.className = 'photo-quality bad';
    el.textContent = '✕ Foto muito pequena (' + w + 'x' + h + 'px). Envie uma imagem maior.';
  }
}

// ── Preview ───────────────────────────────────────────────────
function updatePreview() {
  var isPJ = document.querySelector('input[name="type"]:checked').value === 'PJ';
  var name = applyCase(document.getElementById('nameInput').value || '<Nome Completo>', 'name');
  var role = applyCase(document.getElementById('roleInput').value || '<Função>', 'role');
  var admDate = document.getElementById('admissionInput').value;
  var cnpj = document.getElementById('cnpjInput').value;

  document.getElementById('badgeFront').className = 'badge-front' + (isPJ ? ' pj' : '');
  document.getElementById('badgeBack').className  = 'badge-back'  + (isPJ ? ' pj' : '');
  document.getElementById('previewName').textContent = name;
  document.getElementById('previewRole').textContent = role;

  document.getElementById('cnpjField').style.display      = isPJ ? 'block' : 'none';
  document.getElementById('admissionField').style.display = isPJ ? 'none'  : 'block';

  if (isPJ) {
    document.getElementById('backLabel').textContent  = 'CNPJ:';
    document.getElementById('previewDate').textContent = cnpj || '<Número>';
  } else {
    document.getElementById('backLabel').textContent  = 'Admissão:';
    if (admDate) {
      var p = admDate.split('-');
      document.getElementById('previewDate').textContent = p[2] + '/' + p[1] + '/' + p[0];
    } else {
      document.getElementById('previewDate').textContent = '00/00/00';
    }
  }
}

function generateBadge() {
  updatePreview();
  document.getElementById('exportBtns').className = 'export-btns visible';
}

// ── Canvas constants (300dpi + 3mm bleed) ────────────────────
var DPI   = 300;
var MM    = DPI / 25.4;
var BW    = Math.round(54 * MM);
var BH    = Math.round(86 * MM);
var BLEED = Math.round(3  * MM);
var CW    = BW + BLEED * 2;
var CH    = BH + BLEED * 2;

function rr(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function drawBase(ctx, color) {
  ctx.fillStyle = color;
  ctx.fillRect(0, 0, CW, CH);
  // Crop marks
  ctx.strokeStyle = '#000'; ctx.lineWidth = 1;
  var g = 4, mk = 12;
  [[BLEED-g-mk,BLEED,BLEED-g,BLEED],[0,BLEED-g-mk,0,BLEED-g],
   [CW-BLEED+g,BLEED,CW-BLEED+g+mk,BLEED],[CW-BLEED+g,0,CW-BLEED+g,BLEED-g],
   [BLEED-g-mk,CH-BLEED,BLEED-g,CH-BLEED],[0,CH-BLEED+g,0,CH-BLEED+g+mk],
   [CW-BLEED+g,CH-BLEED,CW-BLEED+g+mk,CH-BLEED],[CW-BLEED+g,CH-BLEED+g,CW-BLEED+g,CH-BLEED+g+mk]
  ].forEach(function(pts) {
    ctx.beginPath(); ctx.moveTo(pts[0],pts[1]); ctx.lineTo(pts[2],pts[3]); ctx.stroke();
  });
}

function wrapText(ctx, text, maxWidth) {
  var words = text.split(' ');
  var lines = [];
  var current = '';
  for (var i = 0; i < words.length; i++) {
    var test = current ? current + ' ' + words[i] : words[i];
    if (ctx.measureText(test).width > maxWidth && current) {
      lines.push(current);
      current = words[i];
    } else {
      current = test;
    }
  }
  if (current) lines.push(current);
  return lines;
}

function drawFront(ctx, color, name, role) {
  drawBase(ctx, color);
  var ox = BLEED, oy = BLEED;

  // Slot
  var sw = Math.round(13*MM), sh = Math.round(4*MM);
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  rr(ctx, ox+BW/2-sw/2, oy+Math.round(3.5*MM), sw, sh, sh/2); ctx.fill();

  // Brand
  ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
  ctx.font = 'bold ' + Math.round(5*MM) + 'px Helvetica,Arial';
  ctx.fillText('INDEPENDENT', ox+BW/2, oy+Math.round(15*MM));
  ctx.fillText('BRAZIL',      ox+BW/2, oy+Math.round(21.5*MM));

  // Photo circle
  var cx = ox+BW/2, cy = oy+Math.round(48*MM), cr = Math.round(19*MM);
  ctx.beginPath(); ctx.arc(cx, cy, cr, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = Math.round(0.5*MM); ctx.stroke();

  return { cx:cx, cy:cy, cr:cr, ox:ox, oy:oy };
}

function finishFront(ctx, info, name, role) {
  var ox = info.ox, oy = info.oy;
  var maxW = BW - Math.round(16*MM);
  var lineH = Math.round(4.5*MM);

  // Name with word wrap
  ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
  ctx.font = 'bold ' + Math.round(3.8*MM) + 'px Helvetica,Arial';
  var nameLines = wrapText(ctx, name, maxW);
  for (var i = 0; i < nameLines.length; i++) {
    ctx.fillText(nameLines[i], ox+BW/2, oy+Math.round(74*MM) + i*lineH);
  }

  // Role with word wrap — starts right after name
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.font = Math.round(3.0*MM) + 'px Helvetica,Arial';
  var roleLineH = Math.round(4*MM);
  var roleStartY = oy+Math.round(74*MM) + nameLines.length * lineH;
  var roleLines = wrapText(ctx, role, maxW);
  for (var j = 0; j < roleLines.length; j++) {
    ctx.fillText(roleLines[j], ox+BW/2, roleStartY + j*roleLineH);
  }
}

function drawBack(ctx, color, bottomLabel, bottomValue) {
  drawBase(ctx, color);
  var ox = BLEED, oy = BLEED;

  // Slot
  var sw = Math.round(13*MM), sh = Math.round(4*MM);
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  rr(ctx, ox+BW/2-sw/2, oy+Math.round(3.5*MM), sw, sh, sh/2); ctx.fill();

  // IB Logo — centered
  var ls = Math.round(28*MM);
  var lx = ox+BW/2 - ls/2;
  var ly = oy+BH/2 - ls/2 - Math.round(2*MM);
  ctx.strokeStyle = '#fff'; ctx.lineWidth = Math.round(2.6*MM);
  ctx.strokeRect(lx, ly, ls, ls);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold ' + Math.round(20*MM) + 'px Helvetica,Arial';
  ctx.textAlign = 'center';
  ctx.fillText('IB', ox+BW/2, ly+ls-Math.round(5.5*MM));

  // Bottom info
  ctx.fillStyle = 'rgba(255,255,255,0.45)';
  ctx.font = Math.round(2.5*MM) + 'px Helvetica,Arial';
  ctx.fillText(bottomLabel, ox+BW/2, oy+BH-Math.round(14*MM));
  ctx.fillStyle = '#fff';
  ctx.font = 'bold ' + Math.round(3.2*MM) + 'px Helvetica,Arial';
  ctx.fillText(bottomValue, ox+BW/2, oy+BH-Math.round(9.8*MM));
  ctx.font = 'bold ' + Math.round(2.8*MM) + 'px Helvetica,Arial';
  ctx.fillText('www.independentbrazil.com', ox+BW/2, oy+BH-Math.round(5.5*MM));
}

// ── Render to canvas ──────────────────────────────────────────
function getVals() {
  var isPJ = document.querySelector('input[name="type"]:checked').value === 'PJ';
  var name = applyCase(document.getElementById('nameInput').value || 'Nome Completo', 'name');
  var role = applyCase(document.getElementById('roleInput').value || 'Função', 'role');
  var admDate = document.getElementById('admissionInput').value;
  var cnpj = document.getElementById('cnpjInput').value;
  var color = isPJ ? '#5a5a5a' : '#111111';
  var type  = isPJ ? 'PJ' : 'CLT';
  var bottomLabel = isPJ ? 'CNPJ:' : 'Admissão:';
  var bottomValue;
  if (isPJ) {
    bottomValue = cnpj || '<Número>';
  } else if (admDate) {
    var p = admDate.split('-');
    bottomValue = p[2] + '/' + p[1] + '/' + p[0];
  } else {
    bottomValue = '<00/00/00>';
  }
  return { isPJ:isPJ, name:name, role:role, color:color, type:type, bottomLabel:bottomLabel, bottomValue:bottomValue };
}

function renderFront(canvas, vals) {
  return new Promise(function(resolve) {
    canvas.width = CW; canvas.height = CH;
    var ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
    var info = drawFront(ctx, vals.color, vals.name, vals.role);
    if (photoDataURL) {
      var img = new Image();
      img.onload = function() {
        ctx.save();
        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
        ctx.beginPath(); ctx.arc(info.cx, info.cy, info.cr, 0, Math.PI*2); ctx.clip();
        // Cover crop — sem achatamento
        var d = info.cr * 2;
        var scale = Math.max(d / img.naturalWidth, d / img.naturalHeight);
        var sw2 = img.naturalWidth * scale, sh2 = img.naturalHeight * scale;
        ctx.drawImage(img, info.cx - sw2/2, info.cy - sh2/2, sw2, sh2);
        ctx.restore();
        finishFront(ctx, info, vals.name, vals.role);
        resolve(canvas.toDataURL('image/png'));
      };
      img.src = photoDataURL;
    } else {
      ctx.fillStyle = 'rgba(255,255,255,0.1)';
      ctx.beginPath(); ctx.arc(info.cx, info.cy, info.cr, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.font = Math.round(2.5*MM) + 'px Helvetica,Arial'; ctx.textAlign = 'center';
      ctx.fillText('FOTO 35x35', info.cx, info.cy + Math.round(1*MM));
      finishFront(ctx, info, vals.name, vals.role);
      resolve(canvas.toDataURL('image/png'));
    }
  });
}

function renderBack(canvas, vals) {
  return new Promise(function(resolve) {
    canvas.width = CW; canvas.height = CH;
    var ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
    drawBack(ctx, vals.color, vals.bottomLabel, vals.bottomValue);
    resolve(canvas.toDataURL('image/png'));
  });
}

// ── Downloads ─────────────────────────────────────────────────
function triggerDownload(dataURL, filename) {
  var link = document.createElement('a');
  link.download = filename;
  link.href = dataURL;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function downloadPNG() {
  var vals = getVals();
  var canvas = document.getElementById('exportCanvas');
  var frontURL = await renderFront(canvas, vals);
  triggerDownload(frontURL, 'cracha-' + vals.type + '-FRENTE-300dpi.png');
  await new Promise(function(r){ setTimeout(r, 800); });
  var backURL = await renderBack(canvas, vals);
  triggerDownload(backURL, 'cracha-' + vals.type + '-VERSO-300dpi.png');
}

async function downloadPDF() {
  var vals = getVals();
  var canvas = document.getElementById('exportCanvas');

  var pageW = 54, pageH = 86, specH = pageH + 32;

  var frontURL = await renderFront(canvas, vals);
  var backURL  = await renderBack(canvas, vals);

  var jsPDF = window.jspdf.jsPDF;
  var pdf = new jsPDF({ orientation:'portrait', unit:'mm', format:[pageW, specH] });

  // Pág 1 — Frente
  var frontClean = await roundedCrop(frontURL, pageW, pageH, 2);
  pdf.addImage(frontClean, 'JPEG', 0, 0, pageW, pageH, undefined, 'NONE');
  addFooter(pdf, pageW, pageH, vals, 'FRENTE', 'PVCL 0,76mm – BRILHO');

  // Pág 2 — Verso
  pdf.addPage([pageW, specH]);
  var backClean = await roundedCrop(backURL, pageW, pageH, 2);
  pdf.addImage(backClean, 'JPEG', 0, 0, pageW, pageH, undefined, 'NONE');
  addFooter(pdf, pageW, pageH, vals, 'VERSO', 'PVCL 0,76mm – FOSCO');

  pdf.setProperties({
    title: 'Crachá IB – ' + vals.type,
    subject: 'Independent Brazil – Arquivo para gráfica',
    author: 'Independent Brazil',
    creator: 'Crachá IB App'
  });

  pdf.save('cracha-IB-' + vals.type + '-GRAFICA.pdf');
}

function roundedCrop(imgURL, wMM, hMM, rMM) {
  return new Promise(function(resolve) {
    var sc = 300 / 25.4; // px per mm @ 300dpi
    var bleed = Math.round(3 * sc);
    var W = Math.round(wMM * sc);
    var H = Math.round(hMM * sc);
    var R = rMM * sc;

    var img = new Image();
    img.onload = function() {
      var tmp = document.createElement('canvas');
      tmp.width = W; tmp.height = H;
      var ctx = tmp.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      // Rounded clip
      ctx.beginPath();
      ctx.moveTo(R, 0);
      ctx.lineTo(W-R, 0); ctx.quadraticCurveTo(W, 0, W, R);
      ctx.lineTo(W, H-R); ctx.quadraticCurveTo(W, H, W-R, H);
      ctx.lineTo(R, H);   ctx.quadraticCurveTo(0, H, 0, H-R);
      ctx.lineTo(0, R);   ctx.quadraticCurveTo(0, 0, R, 0);
      ctx.closePath();
      ctx.clip();

      // Draw cropping the bleed from the PNG
      ctx.drawImage(img, bleed, bleed, img.naturalWidth - bleed*2, img.naturalHeight - bleed*2, 0, 0, W, H);

      resolve(tmp.toDataURL('image/jpeg', 1.0));
    };
    img.src = imgURL;
  });
}

function addRoundedImageToPDF() {} // legacy stub, não usada

function addFooter(pdf, pageW, pageH, vals, face, material) {
  var y0 = pageH + 3;
  var cx = pageW / 2;
  pdf.setDrawColor(180); pdf.setLineWidth(0.2); pdf.line(3, y0, pageW-3, y0);
  pdf.setFont('helvetica','bold'); pdf.setFontSize(5); pdf.setTextColor(30);
  pdf.text(vals.type + ' | ' + face, cx, y0+4, { align:'center' });
  pdf.setFont('helvetica','normal'); pdf.setFontSize(4); pdf.setTextColor(80);
  var specs = [
    ['Material', material], ['Dimensões', '54 × 86 mm'],
    ['Sangria', '3 mm (todos os lados)'], ['Resolução', '300 dpi'],
    ['Tamanho final', '708 × 1086 px'], ['Cor', vals.isPJ ? 'Cinza' : 'Preto']
  ];
  specs.forEach(function(s, i) {
    var col = i % 2, row = Math.floor(i / 2);
    var x = col === 0 ? 4 : cx + 2;
    var y = y0 + 9 + row * 5.5;
    pdf.setFont('helvetica','bold'); pdf.setTextColor(30); pdf.text(s[0] + ':', x, y);
    pdf.setFont('helvetica','normal'); pdf.setTextColor(80); pdf.text(s[1], x+14, y);
  });
  pdf.setFontSize(3.5); pdf.setTextColor(150);
  pdf.text('Gerado por Crachá IB App · Independent Brazil', cx, y0+27, { align:'center' });
}

updatePreview();
</script>
</body>
</html>
